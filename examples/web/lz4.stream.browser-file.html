<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LZ4 Stream: File to File</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-top: 20px; }
        button { cursor: pointer; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:disabled { background: #ccc; }
        #status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<h1>LZ4 Streaming File Compression</h1>
<p>Select a file to compress it on-the-fly using <code>LZ4.compressStream()</code>.</p>

<div class="box">
    <input type="file" id="fileInput" />
    <br><br>
    <button id="processBtn" disabled>Compress & Download</button>
    <div id="status">Waiting for file...</div>
</div>

<script type="module">
    // Import from your local build or relative path
    import { LZ4 } from '/src/lz4.js';

    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const statusDiv = document.getElementById('status');

    let selectedFile = null;

    fileInput.addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            processBtn.disabled = false;
            statusDiv.textContent = `Ready to compress: ${selectedFile.name} (${formatSize(selectedFile.size)})`;
        }
    });

    processBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        try {
            processBtn.disabled = true;
            statusDiv.textContent = "Compressing stream...";
            const startTime = performance.now();

            // --- THE CORE LOGIC ---

            // 1. Get ReadableStream from the Input File
            const inputStream = selectedFile.stream();

            // 2. Create the Compression Transform Stream
            const compressStream = LZ4.compressStream();

            // 3. Pipe Input -> Compressor
            const compressedStream = inputStream.pipeThrough(compressStream);

            // 4. Consume the stream into a new Blob/File
            // The Response constructor is a handy trick to turn a Stream into a Blob
            const response = new Response(compressedStream);
            const blob = await response.blob();

            // ----------------------

            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(0);

            // Create Download Link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name}.lz4`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            statusDiv.innerHTML = `
                    ✅ Done in ${duration}ms!<br>
                    Original: ${formatSize(selectedFile.size)}<br>
                    Compressed: ${formatSize(blob.size)}<br>
                    Ratio: ${(blob.size / selectedFile.size * 100).toFixed(2)}%
                `;
        } catch (err) {
            console.error(err);
            statusDiv.textContent = "❌ Error: " + err.message;
        } finally {
            processBtn.disabled = false;
        }
    });

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
</body>
</html>