<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LZ4 Web Worker Demo</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; line-height: 1.6; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        h1 { border-bottom: 2px solid #ddd; padding-bottom: 10px; }

        /* Status Indicators */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .badge.green { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge.red { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .badge.yellow { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* Controls */
        button { padding: 10px 20px; margin-top: 10px; cursor: pointer; font-size: 16px; }

        /* Log Output */
        #log {
            margin-top: 20px; padding: 10px; border: 1px solid #999;
            background: #fff; height: 250px; overflow-y: scroll; font-family: monospace; font-size: 0.9em;
        }

        /* Responsiveness Test Animation */
        .spinner-container {
            display: flex; align-items: center; margin: 20px 0; padding: 10px; background: #e9ecef; border-radius: 5px;
        }
        .spinner {
            width: 30px; height: 30px; border: 5px solid #ccc; border-top-color: #007bff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-right: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <a href="/" style="text-decoration: none; font-size: 0.9em;">&larr; Back to Examples</a>
    <h1>LZ4 Web Worker (Off-Thread)</h1>

    <p>
        <strong>Environment Status: </strong>
        <span id="sabStatus" class="badge">Checking...</span>
    </p>
    <p>
        If <strong>SharedArrayBuffer</strong> is enabled, data is shared with the worker (Zero-Copy).
        If not, data is copied (slower). Use the Node.js server to see headers in action.
    </p>

    <div class="spinner-container">
        <div class="spinner"></div>
        <div>
            <strong>UI Responsiveness Test:</strong><br>
            If this spinner stops moving, the Main Thread is blocked. <br>
            With Web Workers, this should <em>never</em> freeze.
        </div>
    </div>

    <input type="file" id="fileInput" />
    <br>
    <button id="runBtn" disabled>Compress & Decompress (Worker)</button>

    <div id="log"></div>
</div>

<script type="module">
    import { LZ4 } from '/src/lz4.js';

    const fileInput = document.getElementById('fileInput');
    const runBtn = document.getElementById('runBtn');
    const logDiv = document.getElementById('log');
    const sabStatus = document.getElementById('sabStatus');

    // 1. Check Environment Capabilities
    if (window.crossOriginIsolated) {
        sabStatus.textContent = "✅ SharedArrayBuffer Enabled (Fast)";
        sabStatus.className = "badge green";
    } else {
        sabStatus.textContent = "⚠️ SharedArrayBuffer Disabled (Copy Mode)";
        sabStatus.className = "badge red";
    }

    // 2. Enable button on file select
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) runBtn.disabled = false;
    });

    // 3. Helper for Logging
    function log(msg) {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // 4. Main Workflow
    runBtn.addEventListener('click', async () => {
        const file = fileInput.files[0];
        if (!file) return;

        runBtn.disabled = true;
        log('------------------------------------------------');
        log(`Starting job for: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

        try {
            // --- Step A: Read File ---
            log('reading file into memory...');
            const arrayBuffer = await file.arrayBuffer();
            const inputBytes = new Uint8Array(arrayBuffer);

            // --- Step B: Compress (Off-Thread) ---
            log('⏳ Sending to Worker for Compression...');
            const startC = performance.now();

            // CALLING THE WORKER API
            const compressedBytes = await LZ4.compressWorker(inputBytes);

            const endC = performance.now();
            const durationC = (endC - startC).toFixed(2);

            log(`✅ Compression Complete!`);
            log(`   Time: ${durationC}ms`);
            log(`   Original: ${inputBytes.byteLength.toLocaleString()} bytes`);
            log(`   Compressed: ${compressedBytes.byteLength.toLocaleString()} bytes`);
            log(`   Ratio: ${((compressedBytes.byteLength / inputBytes.byteLength) * 100).toFixed(2)}%`);

            // --- Step C: Decompress (Off-Thread) ---
            // UPDATE: Removed legacy originalSize argument.
            // The Frame format now handles size automatically.
            log('⏳ Sending to Worker for Decompression...');
            const startD = performance.now();

            const restoredBytes = await LZ4.decompressWorker(compressedBytes);

            const endD = performance.now();
            const durationD = (endD - startD).toFixed(2);

            log(`✅ Decompression Complete!`);
            log(`   Time: ${durationD}ms`);

            // --- Step D: Verify ---
            if (restoredBytes.byteLength === inputBytes.byteLength) {
                log(`✨ Success: Restored size matches original.`);
            } else {
                log(`❌ Error: Size mismatch!`);
            }

        } catch (err) {
            console.error(err);
            log(`❌ Error: ${err.message}`);
        } finally {
            runBtn.disabled = false;
        }
    });
</script>
</body>
</html>